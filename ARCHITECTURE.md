# DeepDecoy Architecture

# DeepDecoy Architecture

## Overview
DeepDecoy is an adaptive, AI-driven honeypot simulating SSH and Web services. It uses persona-based deception and a learning feedback loop to bias future interactions for higher engagement and threat exposure, while remaining fully safe (no real commands executed).

## Components
- `main.py`: Orchestrates services (SSH + Web) and the deception engine, includes a CLI to run learning and optionally start the dashboard.
- `ai_shell.py`: Generates realistic terminal outputs for SSH interactions using AI or deterministic offline fallbacks.
- `web_server.py`: Flask web honeypot serving HTML and JSON responses.
- `web_ai_responder.py`: AI or offline responder for web requests.
- `deception_engine.py`: Core adaptive persona logic, integrates learned strategy weights to bias persona selection.
- `personas.py`: Persona definitions and metadata.
- `session_logger.py`: Structured JSON and text logging for sessions.
- `learning_engine.py`: Aggregates session metrics and updates persona strategy weights (SQLite or JSON), reads session logs from `logs/sessions` or `logs/` fallback.
- `dashboard.py`: Local dashboard for overview, sessions, timelines, and persona metrics.
- `analyzer.py`: Post-session threat intelligence.

## Data Flow
1. Attacker connects to SSH or web endpoints.
2. Requests and commands are categorized and logged (`session_logger`).
3. Deception engine evaluates behavior every `DECEPTION_EVAL_INTERVAL` interactions and may switch personas.
4. After sessions, `learning_engine` processes logs to compute engagement/threat metrics and update `persona_strategy`.
5. Dashboard visualizes stored metrics from SQLite and shows per-session timelines and persona effectiveness.

## Storage
- SQLite database at `data/deepdecoy.db` (if `USE_SQLITE=true`).
- JSON strategy fallback at `strategy/persona_strategy.json`.
- Logs stored under `logs/` (`session_*.json`, `session_*.txt`, summaries).
- Web logs under `logs/web/`.

## Configuration
Key environment variables in `.env`:
- `DEEPDECOY_DISABLE_OPENAI`: Offline deterministic mode.
- `DECEPTION_EVAL_INTERVAL`: Interactions between persona evaluations.
- `INITIAL_PERSONA`: Starting persona name.
- `ENABLE_DASHBOARD`, `DASHBOARD_PORT`: Dashboard options.
- `USE_SQLITE`, `LEARNING_DB_PATH`: Learning storage.
- `SSH_PORT`, `SSH_HOST`, `WEB_PORT`, `WEB_HOST`: Service bindings.

## Persona System
Personas define prompts and metadata affecting SSH and Web response styles. Heuristic triggers in offline mode map keywords (e.g., sql → MySQL Backend, firmware → IoT Hub, admin/cms/wp- → Vulnerable Web CMS).

## Offline Mode
When OpenAI is disabled, responses are generated by deterministic functions. The deception engine still runs heuristic persona selection and integrates learned weights from `persona_strategy`.

## Dashboard
Flask app providing:
- Overview: total sessions, top personas, average engagement/threat.
- Sessions list: sortable table.
- Session detail: timeline of commands/requests and persona transitions.
- Personas view: effectiveness and strategy weights.

## Security Safeguards
- No real command execution; AI-generated outputs only.
- Secrets kept in `.env` (never committed).
- Safe defaults for ports/bind addresses; do not expose without proper controls.
- `web_server.py`: Flask catch-all with per-IP `DeceptionEngine` instances.
- `ai_shell.py`: SSH command response generation and categorization.
- `web_ai_responder.py`: Dynamic HTML/JSON response generation.
- `deception_engine.py`: Adaptive persona management + heuristic fallback.
- `personas.py`: Static persona definitions (prompts, modules, metadata).
- `session_logger.py`: Structured JSON + human-readable logs + persona transition recording.
- `analyzer.py`: Post-session threat intelligence.
- `config.py`: Environment-driven configuration including adaptive settings.

## Persona Switching Logic
Evaluation occurs every `DECEPTION_EVAL_INTERVAL` interactions:
- Collect last N (≤10) interactions.
- GPT decision contract:
  ```json
  {"action":"stay"|"switch","new_persona":"Name","reason":"Short justification"}
  ```
- If OpenAI disabled, heuristics match keywords → persona mapping.
- Transition logs appended to `deception_transitions` and included in web/SSH logs.

## Logging Structure
- SSH session logs: `logs/session_<timestamp>_<ip>_<uuid>.json|.txt|.summary.txt`
- Web daily log: `logs/web/web_<date>.json` containing request array plus global persona transitions.
- Each command/request tagged with category + persona state (web includes `persona`, optional `persona_transition`).

## Security Boundaries
- No command execution; outputs purely synthetic.
- Sanitized OpenAI inputs; large commands truncated to `MAX_COMMAND_LENGTH`.
- Persona metadata purely descriptive; does not expose host internals.

## Extensibility Points
- Add persona: extend `PERSONAS` + optional heuristic keywords.
- Add protocol: new service layer invokes common logging + deception engine.
- Modify threat detection: extend categorization in `ai_shell.py` and analyzer logic.
- Swap LLM provider: abstract client creation in responders and engine.

## Performance Considerations
- Interaction buffer limited to 25 entries per engine instance.
- Evaluation frequency tunable; higher interval lowers API usage.
- Fallback heuristics ensure functionality offline or during API outages.

## Future Improvements
- Centralized event bus for multi-protocol correlation.
- Streaming token responses for long outputs.
- Persona state graph with weighted transitions instead of rule/LLM only.

---
Architecture designed for clarity, safety, and easy expansion while preserving strict non-execution guarantees.
